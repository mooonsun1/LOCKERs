<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>í˜„ì¥ ì§€ë„í™”ë©´</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', dotum, 'ë‹ì›€', sans-serif;
            font-size: 12px;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ë°”ë¥¼ ìˆ¨ê¸°ê¸° ìœ„í•´ ì„¤ì • */
        }

        .map_wrap {
            display: flex;
            height: 100vh;
            padding: 10px;
            box-sizing: border-box;
            position: relative; /* ìì‹ ìš”ì†Œ ìœ„ì¹˜ ì§€ì •ì— í•„ìš” */
        }

        #overlayText {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            color: blue;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            z-index: 1000;
        }

        #mainText {
            position: absolute;
            top: 10px;
            left: 10px; /* ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            color: blue;
            border-radius: 5px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
            cursor: pointer; /* ì»¤ì„œë¥¼ í¬ì¸í„°ë¡œ ë³€ê²½ */
        }

        #centerText {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            color: blue;
            border-radius: 5px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
            text-align: center;
        }

        #map {
            position : relative;
            width: 75vw; /* ì§€ë„ ë„ˆë¹„ë¥¼ í™”ë©´ ë„ˆë¹„ì˜ 75%ë¡œ ì„¤ì • */
            height: 80%; /* ì§€ë„ ë†’ì´ë¥¼ 100%ë¡œ ì„¤ì • */
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin:auto;
        }

        #menu_wrap {
            position: relative;
            width: 25vw; /* ë©”ë‰´ ë„ˆë¹„ë¥¼ í™”ë©´ ë„ˆë¹„ì˜ 25%ë¡œ ì„¤ì • */
            height: 80%; /* ë©”ë‰´ ë†’ì´ë¥¼ 100%ë¡œ ì„¤ì •*/
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            margin-right: 0px; /* ì§€ë„ê°€ ë©”ë‰´ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ë°± ì¶”ê°€ */
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ì¶”ê°€ */
            margin:auto;
        }

        #menu_wrap .option {
            margin-bottom: 10px;
        }

        #menu_wrap .option form {
            display: flex;
            align-items: center;
        }

        #menu_wrap .option form input[type="text"] {
            flex: 1;
            margin-right: 5px;
        }

        #menu_wrap .option form button {
            flex-shrink: 0;
        }

        #menu_wrap hr {
            margin: 10px 0;
            border: 0;
            border-top: 2px solid #5F5F5F;
        }

        #placesList li {
            list-style: none;
        }

        #placesList .item {
            position: relative;
            border-bottom: 1px solid #888;
            overflow: hidden;
            cursor: pointer;
            min-height: 65px;
        }

        #placesList .item span {
            display: block;
            margin-top: 4px;
        }

        #placesList .item h5,
        #placesList .item .info {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        #placesList .item .info {
            padding: 10px 0 10px 55px;
        }

        #placesList .info .gray {
            color: #8a8a8a;
        }

        #placesList .info .jibun {
            padding-left: 26px;
            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_jibun.png) no-repeat;
        }

        #placesList .info .tel {
            color: #009900;
        }

        #placesList .item .markerbg {
            float: left;
            position: absolute;
            width: 36px;
            height: 37px;
            margin: 10px 0 0 10px;
            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png) no-repeat;
        }

        #pagination {
            margin: 10px auto;
            text-align: center;
        }

        #pagination a {
            display: inline-block;
            margin-right: 10px;
        }

        #pagination .on {
            font-weight: bold;
            cursor: default;
            color: #777;
        }

        .background-image {
            background-image: url('static/imgs/main_img.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }

        #placesList .item .marker_1 {background-position: 0 -10px;}
        #placesList .item .marker_2 {background-position: 0 -56px;}
        #placesList .item .marker_3 {background-position: 0 -102px}
        #placesList .item .marker_4 {background-position: 0 -148px;}
        #placesList .item .marker_5 {background-position: 0 -194px;}
        #placesList .item .marker_6 {background-position: 0 -240px;}
        #placesList .item .marker_7 {background-position: 0 -286px;}
        #placesList .item .marker_8 {background-position: 0 -332px;}
        #placesList .item .marker_9 {background-position: 0 -378px;}
        #placesList .item .marker_10 {background-position: 0 -423px;}
        #placesList .item .marker_11 {background-position: 0 -470px;}
        #placesList .item .marker_12 {background-position: 0 -516px;}
        #placesList .item .marker_13 {background-position: 0 -562px;}
        #placesList .item .marker_14 {background-position: 0 -608px;}
        #placesList .item .marker_15 {background-position: 0 -654px;}

    </style>
</head>
<body>
<div class="map_wrap">
    <div id="menu_wrap" class="bg_white">
        <div class="option">
            <form onsubmit="searchPlaces(); return false;">
                <label for="keyword">í‚¤ì›Œë“œ:</label>
                <input type="text" value="{{ keyword }}" id="keyword" size="15">
                <button type="submit">ê²€ìƒ‰í•˜ê¸°</button>
            </form>
        </div>
        <hr>
        <ul id="placesList"></ul>
        <div id="pagination"></div>
    </div>
    <div id="map"></div>
</div>

<div id="overlayText" class="weather-info">Loading weather...</div>

<!-- ì™¼ìª½ìœ¼ë¡œ ì´ë™í•œ Lockers ë²„íŠ¼ -->
<a href="/" id="mainText" class="button">Lockers</a>

<!-- ì¤‘ì•™ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ -->
<div id="centerText">{{ age }}, {{ gender }}ì—ê²Œ ì¶”ì²œí•˜ëŠ” ì¥ì†Œì…ë‹ˆë‹¤. {{ user_id }}ë‹˜ ì—¬ê¸° ì–´ë•Œìš”~?</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b7a0856b49b8bb457a6fffff4a4d7ad4&libraries=services"></script>
<script>
// ë§ˆì»¤ë¥¼ ë‹´ì„ ë°°ì—´ì…ë‹ˆë‹¤
var markers = [];

// ë§ˆì»¤ì™€ ì¥ì†Œ ì •ë³´ë¥¼ ë§¤í•‘í•  ê°ì²´
var markerMap = {}; 

// ì§€ë„ë¥¼ í‘œì‹œí•  div 
var mapContainer = document.getElementById('map'); 

// ì§€ë„ ê°ì²´ ìƒì„± ë° ì´ˆê¸°í™”
var map;

// ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
var ps = new kakao.maps.services.Places();  

// ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ì´ë‚˜ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì¥ì†Œëª…ì„ í‘œì¶œí•  ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
var infowindow = new kakao.maps.InfoWindow({zIndex:1});

// í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì§€ë„ ì¤‘ì‹¬ ì„¤ì •
function setCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var locPosition = new kakao.maps.LatLng(lat, lng);

            var mapOption = {
                center: locPosition, // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
            };  

            // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
            map = new kakao.maps.Map(mapContainer, mapOption); 

            // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
            var marker = new kakao.maps.Marker({
                position: locPosition
            });
            marker.setMap(map);

            // í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
            map.setCenter(locPosition);

            // ê²€ìƒ‰ì„ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤
            searchPlaces();
        }, function(error) {
            alert('í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ' + error.message);
            // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì„¤ì •
            var defaultLocation = new kakao.maps.LatLng(37.566826, 126.9786567);
            var mapOption = {
                center: defaultLocation, // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
            };  

            // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
            map = new kakao.maps.Map(mapContainer, mapOption);
        });
    } else {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì§€ì˜¤ë¡œì¼€ì´ì…˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì„¤ì •
        var defaultLocation = new kakao.maps.LatLng(37.566826, 126.9786567);
        var mapOption = {
            center: defaultLocation, // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 2 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };  

        // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
        map = new kakao.maps.Map(mapContainer, mapOption);
    }
}

// í‚¤ì›Œë“œë¡œ ì¥ì†Œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
function searchPlaces() {
    var keyword = document.getElementById('keyword').value;

    if (!keyword.replace(/^\s+|\s+$/g, '')) {
        alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return false;
    }

    // ì¥ì†Œê²€ìƒ‰ ê°ì²´ë¥¼ í†µí•´ í‚¤ì›Œë“œë¡œ ì¥ì†Œê²€ìƒ‰ì„ ìš”ì²­í•©ë‹ˆë‹¤
    ps.keywordSearch(keyword, placesSearchCB); 
}

// ì¥ì†Œê²€ìƒ‰ì´ ì™„ë£Œëì„ ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ì…ë‹ˆë‹¤
function placesSearchCB(data, status, pagination) {
    if (status === kakao.maps.services.Status.OK) {
        // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
        // ê²€ìƒ‰ ëª©ë¡ê³¼ ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
        displayPlaces(data);

        // í˜ì´ì§€ ë²ˆí˜¸ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
        displayPagination(pagination);

    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;

    } else if (status === kakao.maps.services.Status.ERROR) {
        alert('ê²€ìƒ‰ ê²°ê³¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
    }
}

function displayPlaces(places) {
    var listEl = document.getElementById('placesList'), 
        menuEl = document.getElementById('menu_wrap'),
        fragment = document.createDocumentFragment(), 
        bounds = new kakao.maps.LatLngBounds(), 
        listStr = '';
    
    // ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ì— ì¶”ê°€ëœ í•­ëª©ë“¤ì„ ì œê±°í•©ë‹ˆë‹¤
    removeAllChildNods(listEl);

    // ì§€ë„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤
    removeMarker();
    
    for (var i=0; i<places.length; i++) {
        // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
        var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x),
            marker = addMarker(placePosition, i), 
            itemEl = getListItem(i, places[i]);

        // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
        bounds.extend(placePosition);

        // ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì— mouseover í–ˆì„ ë•Œ
        // í•´ë‹¹ ì¥ì†Œì— ì¸í¬ìœˆë„ìš°ì— ì¥ì†Œëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
        // mouseout í–ˆì„ ë•ŒëŠ” ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ìŠµë‹ˆë‹¤
        (function(marker, title, placePosition) {
            kakao.maps.event.addListener(marker, 'mouseover', function() {
                displayInfowindow(marker, title);
            });

            kakao.maps.event.addListener(marker, 'mouseout', function() {
                infowindow.close();
            });

            itemEl.onmouseover =  function () {
                displayInfowindow(marker, title);
            };

            itemEl.onmouseout =  function () {
                infowindow.close();
            };

            // ê²€ìƒ‰ ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ ë•Œ
            itemEl.onclick = function () {
                map.setCenter(placePosition); // ì§€ë„ ì¤‘ì‹¬ì„ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
                map.setLevel(3); // í•„ìš”ì— ë”°ë¼ í™•ëŒ€ ë ˆë²¨ ì¡°ì •
                displayInfowindow(marker, title); // í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš°ë„ ì—´ê¸°
            };
        })(marker, places[i].place_name, placePosition);

        fragment.appendChild(itemEl);
    }

    // ê²€ìƒ‰ê²°ê³¼ í•­ëª©ë“¤ì„ ê²€ìƒ‰ê²°ê³¼ ëª©ë¡ Elementì— ì¶”ê°€í•©ë‹ˆë‹¤
    listEl.appendChild(fragment);
    menuEl.scrollTop = 0;

    // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
    map.setBounds(bounds);
}

// ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ Elementë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
function getListItem(index, places) {
    var el = document.createElement('li'),
    itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
                '<div class="info">' +
                '   <h5>' + places.place_name + '</h5>';

    if (places.road_address_name) {
        itemStr += '    <span>' + places.road_address_name + '</span>' +
                    '   <span class="jibun gray">' +  places.address_name  + '</span>';
    } else {
        itemStr += '    <span>' +  places.address_name  + '</span>'; 
    }
                
    itemStr += '  <span class="tel">' + places.phone  + '</span>' +
                '</div>';           

    el.innerHTML = itemStr;
    el.className = 'item';

    return el;
}

// ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
function addMarker(position, idx, title) {
    var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // ë§ˆì»¤ ì´ë¯¸ì§€ url, ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ë¥¼ ì”ë‹ˆë‹¤
        imageSize = new kakao.maps.Size(36, 37),  // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ í¬ê¸°
        imgOptions =  {
            spriteSize : new kakao.maps.Size(36, 691), // ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ì˜ í¬ê¸°
            spriteOrigin : new kakao.maps.Point(0, (idx*46)+10), // ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ ì¤‘ ì‚¬ìš©í•  ì˜ì—­ì˜ ì¢Œìƒë‹¨ ì¢Œí‘œ
            offset: new kakao.maps.Point(13, 37) // ë§ˆì»¤ ì¢Œí‘œì— ì¼ì¹˜ì‹œí‚¬ ì´ë¯¸ì§€ ë‚´ì—ì„œì˜ ì¢Œí‘œ
        },
        markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
        marker = new kakao.maps.Marker({
            position: position, // ë§ˆì»¤ì˜ ìœ„ì¹˜
            image: markerImage 
        });

    marker.setMap(map); // ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
    markers.push(marker);  // ë°°ì—´ì— ìƒì„±ëœ ë§ˆì»¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤

    return marker;
}

// ì§€ë„ ìœ„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤
function removeMarker() {
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }   
    markers = [];
}

// ê²€ìƒ‰ê²°ê³¼ ëª©ë¡ í•˜ë‹¨ì— í˜ì´ì§€ë²ˆí˜¸ë¥¼ í‘œì‹œëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
function displayPagination(pagination) {
    var paginationEl = document.getElementById('pagination'),
        fragment = document.createDocumentFragment(),
        i; 

    // ê¸°ì¡´ì— ì¶”ê°€ëœ í˜ì´ì§€ë²ˆí˜¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤
    while (paginationEl.hasChildNodes()) {
        paginationEl.removeChild (paginationEl.lastChild);
    }

    for (i=1; i<=pagination.last; i++) {
        var el = document.createElement('a');
        el.href = "#";
        el.innerHTML = i;

        if (i===pagination.current) {
            el.className = 'on';
        } else {
            el.onclick = (function(i) {
                return function() {
                    pagination.gotoPage(i);
                }
            })(i);
        }

        fragment.appendChild(el);
    }
    paginationEl.appendChild(fragment);
}

// ê²€ìƒ‰ê²°ê³¼ ëª©ë¡ ë˜ëŠ” ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
// ì¸í¬ìœˆë„ìš°ì— ì¥ì†Œëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
function displayInfowindow(marker, title) {
    var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

    infowindow.setContent(content);
    infowindow.open(map, marker);
}

// ê²€ìƒ‰ê²°ê³¼ ëª©ë¡ì˜ ìì‹ Elementë¥¼ ì œê±°í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
function removeAllChildNods(el) {   
    while (el.hasChildNodes()) {
        el.removeChild (el.lastChild);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì§€ë„ë¥¼ ì„¤ì •
window.onload = function() {
    setCurrentLocation();
    fetchWeather();
};

function addOverlayText() {
    var overlayText = document.getElementById('overlayText');
    // ì´ í•¨ìˆ˜ì˜ ë‚´ìš©ì´ CSSì—ì„œ ì •ì˜ëœ ëŒ€ë¡œ ìŠ¤íƒ€ì¼ì„ ì„¤ì •í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤
}

// ìœ„ë„/ê²½ë„ë¥¼ ê²©ì ì¢Œí‘œë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function latLngToGrid(lat, lng) {
    let RE = 6371.00877; // ì§€êµ¬ ë°˜ê²½(km)
    let GRID = 5.0; // ê²©ì ê°„ê²©(km)
    let SLAT1 = 30.0; // íˆ¬ì˜ ìœ„ë„1(degree)
    let SLAT2 = 60.0; // íˆ¬ì˜ ìœ„ë„2(degree)
    let OLON = 126.0; // ê¸°ì¤€ì  ê²½ë„(degree)
    let OLAT = 38.0; // ê¸°ì¤€ì  ìœ„ë„(degree)
    let XO = 43; // ê¸°ì¤€ì  Xì¢Œí‘œ(GRID)
    let YO = 136; // ê¸°ì¤€ì  Yì¢Œí‘œ(GRID)

    let DEGRAD = Math.PI / 180.0;
    let RADDEG = 180.0 / Math.PI;

    let re = RE / GRID;
    let slat1 = SLAT1 * DEGRAD;
    let slat2 = SLAT2 * DEGRAD;
    let olon = OLON * DEGRAD;
    let olat = OLAT * DEGRAD;

    let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
    sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
    let sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
    sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
    let ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
    ro = re * sf / Math.pow(ro, sn);
    let rs = {};

    let ra = Math.tan(Math.PI * 0.25 + (lat) * DEGRAD * 0.5);
    ra = re * sf / Math.pow(ra, sn);
    let theta = lng * DEGRAD - olon;
    if (theta > Math.PI) theta -= 2.0 * Math.PI;
    if (theta < -Math.PI) theta += 2.0 * Math.PI;
    theta *= sn;

    rs['nx'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
    rs['ny'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);

    // ì´ì „ì— ì‚¬ìš©ëœ 'script' ë³€ìˆ˜ ëŒ€ì‹  ì˜¬ë°”ë¥¸ ë³€ìˆ˜ëª…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    return rs;
}


async function fetchWeather() {
    navigator.geolocation.getCurrentPosition(async function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const grid = latLngToGrid(lat, lng); // ìœ„ë„/ê²½ë„ë¥¼ ê²©ì ì¢Œí‘œë¡œ ë³€í™˜

        const apiKey = 'Ov/KK7UkpoS4KR+njSJxOjQQosvtbkC8fqJhzKmSLFbSkgoSPXH+4HMJ5TmGKZBNoKC20CWaDQKYqEUs4pIXWA==';
        const baseUrl = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst';

        const currentDate = new Date();
        const baseDate = currentDate.toISOString().split('T')[0].replace(/-/g, '');
        const baseTime = currentDate.getHours().toString().padStart(2, '0') + '00';

        const params = new URLSearchParams({
            serviceKey: apiKey,
            pageNo: '1',
            numOfRows: '10',
            dataType: 'XML',
            base_date: baseDate,
            base_time: baseTime,
            nx: grid.nx, // ë³€í™˜ëœ ê²©ì ì¢Œí‘œ ì‚¬ìš©
            ny: grid.ny  // ë³€í™˜ëœ ê²©ì ì¢Œí‘œ ì‚¬ìš©
        });
        
        try {
            const response = await fetch(`${baseUrl}?${params}`);
            const text = await response.text();
            
            console.log(text);

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');
            const items = xmlDoc.getElementsByTagName('item');

            let temp = null;
            let sky = null;

            for (let item of items) {
                const category = item.getElementsByTagName('category')[0].textContent;
                const obsrValue = item.getElementsByTagName('obsrValue')[0].textContent;

                if (category === 'T1H') {
                    temp = obsrValue;
                }
                if (category === 'PTY') {
                    sky = obsrValue;
                }
            }

            const intToWeather = {
                "0": ["ë§‘ìŒ", "â˜€ï¸"],
                "1": ["ë¹„", "ğŸŒ§ï¸"],
                "2": ["ë¹„/ëˆˆ", "ğŸŒ¦ï¸"],
                "3": ["ëˆˆ", "â„ï¸"],
                "5": ["ë¹—ë°©ìš¸", "ğŸŒ¦ï¸"],
                "6": ["ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼", "ğŸŒ§ï¸ğŸŒ¨ï¸"],
                "7": ["ëˆˆë‚ ë¦¼", "ğŸŒ¨ï¸"]
            };

            const skyDescription = sky !== null ? intToWeather[sky][0] : "ì •ë³´ ì—†ìŒ";
            const skyEmoji = sky !== null ? intToWeather[sky][1] : "â“";

            const weatherInfo = `í˜„ì¬ ê¸°ì˜¨: ${temp !== null ? temp + 'Â°C' : 'ì •ë³´ ì—†ìŒ'}<br>í˜„ì¬ ë‚ ì”¨: ${skyDescription} ${skyEmoji}`;

            document.getElementById('overlayText').innerHTML = weatherInfo;

        } catch (error) {
            console.error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
            document.getElementById('overlayText').innerHTML = 'ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
    }, function(error) {
        console.error('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
        document.getElementById('overlayText').innerHTML = 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
    });
}
</script>
</body>
</html>
